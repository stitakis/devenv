#!/usr/bin/env bash
set -eux
# this script sets up a fresh CentOS 7 installation with an ODS installation based on an OpenShift cluster started with oc cluster up

# Check whether VM is setup correctly
if [[ -z $(grep vmx /proc/cpuinfo) ]]; then
    echo "The VM needs to be configured to enable hypervisor applications. Stopping now."
    exit 1
fi
# debug log available memory and diskspace
free -m
df -h

sudo yum install -y docker
sudo systemctl enable --now docker

echo "updating docker insecure registries"
cat <<EOF |
{
    "insecure-registries": [
        "172.30.0.0/16"
    ]
}
EOF
sudo tee /etc/docker/daemon.json
sudo systemctl restart docker.service

echo "Configuring firewall for docker containers:"
sudo firewall-cmd --permanent --new-zone dockerc
sudo firewall-cmd --permanent --zone dockerc --add-source 172.17.0.0/16
sudo firewall-cmd --permanent --zone dockerc --add-port 8443/tcp
sudo firewall-cmd --permanent --zone dockerc --add-port 53/udp
sudo firewall-cmd --permanent --zone dockerc --add-port 8053/udp
sudo firewall-cmd --reload

echo "Installing OpenShift client"
sudo yum install -y centos-release-openshift-origin311
sudo yum install -y origin-clients
echo "Starting up oc cluster for the first time"
sudo oc cluster up --base-dir=${HOME}/openshift.local.clusterup
oc login -u developer
sudo oc login -u system:admin
oc projects


